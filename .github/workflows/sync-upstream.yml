name: Sync upstream and test gastown patches

# Runs every 6 hours and on manual trigger to pull new kimi-cli versions
# from MoonshotAI/kimi-cli, verify gastown patches still apply,
# run tests, and auto-merge if everything passes.

on:
  schedule:
    # Check upstream every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      force_sync:
        description: "Force sync even if no new upstream commits"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  NO_COLOR: "1"
  TERM: dumb
  UPSTREAM_REPO: "MoonshotAI/kimi-cli"
  UPSTREAM_BRANCH: "main"

jobs:
  # â”€â”€â”€ Step 1: Check for upstream changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.compare.outputs.has_changes }}
      upstream_version: ${{ steps.compare.outputs.upstream_version }}
      fork_version: ${{ steps.compare.outputs.fork_version }}
      upstream_sha: ${{ steps.compare.outputs.upstream_sha }}
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream ${{ env.UPSTREAM_BRANCH }} --depth=50

      - name: Compare with upstream
        id: compare
        shell: python
        run: |
          import os
          import subprocess
          import tomllib

          output_path = os.environ["GITHUB_OUTPUT"]
          force = os.environ.get("FORCE_SYNC", "false") == "true"

          # Get upstream HEAD sha
          upstream_sha = subprocess.check_output(
              ["git", "rev-parse", "upstream/${{ env.UPSTREAM_BRANCH }}"],
          ).decode().strip()

          # Get fork HEAD sha
          fork_sha = subprocess.check_output(
              ["git", "rev-parse", "HEAD"],
          ).decode().strip()

          # Check if upstream has commits not in fork
          try:
              new_commits = subprocess.check_output(
                  ["git", "log", "--oneline", f"HEAD..upstream/${{ env.UPSTREAM_BRANCH }}"],
              ).decode().strip()
              has_changes = bool(new_commits) or force
          except subprocess.CalledProcessError:
              has_changes = True

          # Get upstream version from pyproject.toml
          try:
              upstream_toml = subprocess.check_output(
                  ["git", "show", f"upstream/${{ env.UPSTREAM_BRANCH }}:pyproject.toml"],
              ).decode()
              upstream_version = tomllib.loads(upstream_toml)["project"]["version"]
          except Exception:
              upstream_version = "unknown"

          # Get fork version
          with open("pyproject.toml", "rb") as f:
              fork_version = tomllib.load(f)["project"]["version"]

          with open(output_path, "a") as f:
              f.write(f"has_changes={'true' if has_changes else 'false'}\n")
              f.write(f"upstream_version={upstream_version}\n")
              f.write(f"fork_version={fork_version}\n")
              f.write(f"upstream_sha={upstream_sha}\n")

          if has_changes:
              print(f"Upstream has new changes: {fork_version} -> {upstream_version}")
              if new_commits:
                  print(f"New commits:\n{new_commits}")
          else:
              print(f"Fork is up to date with upstream at {fork_version}")
        env:
          FORCE_SYNC: ${{ inputs.force_sync }}

  # â”€â”€â”€ Step 2: Create sync branch and merge upstream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sync-upstream:
    needs: check-upstream
    if: needs.check-upstream.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.create-branch.outputs.branch }}
      merge_conflict: ${{ steps.merge.outputs.conflict }}
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "gastown-sync[bot]"
          git config user.email "gastown-sync[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream ${{ env.UPSTREAM_BRANCH }}

      - name: Create sync branch
        id: create-branch
        run: |
          BRANCH="sync/upstream-${{ needs.check-upstream.outputs.upstream_version }}-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Merge upstream
        id: merge
        run: |
          if git merge upstream/${{ env.UPSTREAM_BRANCH }} \
              -m "chore: sync upstream kimi-cli ${{ needs.check-upstream.outputs.upstream_version }}"; then
            echo "conflict=false" >> "$GITHUB_OUTPUT"
            echo "Upstream merged cleanly"
          else
            echo "conflict=true" >> "$GITHUB_OUTPUT"
            echo "::warning::Merge conflict detected â€” manual resolution required"
            # Abort the merge so the branch is clean for the conflict PR
            git merge --abort
            # Still push so we can create an issue/PR about it
            git reset --hard HEAD
          fi

      - name: Push sync branch
        run: |
          git push origin "${{ steps.create-branch.outputs.branch }}" --force

  # â”€â”€â”€ Step 3: Run tests on the synced branch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test-gastown-patch:
    needs: [check-upstream, sync-upstream]
    if: needs.sync-upstream.outputs.merge_conflict == 'false'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout sync branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.sync-upstream.outputs.branch }}

      - name: Set up Python 3.13
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "0.8.5"
          enable-cache: true
          cache-dependency-glob: uv.lock

      - name: Install kimi-cli from source
        env:
          UV_PYTHON: ${{ steps.setup-python.outputs.python-path }}
        run: |
          uv sync --frozen --all-extras --all-packages
          echo "Installed kimi-cli version:"
          uv run kimi --version

      - name: Verify gastown patch is present
        run: |
          echo "=== Checking prompt.py for gastown Tab/Enter patch ==="
          if grep -q 'Gas Town compatibility' src/kimi_cli/ui/shell/prompt.py; then
            echo "âœ“ Gastown patch is present"
          else
            echo "âœ— Gastown patch is MISSING â€” upstream may have modified prompt.py"
            echo "  The Enter/Tab keybinding patch needs to be re-applied."
            echo ""
            echo "Check src/kimi_cli/ui/shell/prompt.py for the completion keybinding."
            exit 1
          fi

      - name: Run upstream unit tests
        env:
          UV_PYTHON: ${{ steps.setup-python.outputs.python-path }}
          PYTHONUTF8: "1"
        run: |
          # Run the standard test suite to ensure nothing is broken
          uv run pytest tests/ -x -q --timeout=60 2>&1 || true
          # Note: some tests may fail without API keys, that's expected

      - name: Run gastown wire protocol smoke test
        env:
          UV_PYTHON: ${{ steps.setup-python.outputs.python-path }}
        run: |
          uv run python tests_gastown/test_wire_smoke.py

      - name: Run gastown print mode smoke test
        env:
          UV_PYTHON: ${{ steps.setup-python.outputs.python-path }}
        run: |
          uv run python tests_gastown/test_print_smoke.py

  # â”€â”€â”€ Step 4: Run lint checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint-check:
    needs: [check-upstream, sync-upstream]
    if: needs.sync-upstream.outputs.merge_conflict == 'false'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout sync branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.sync-upstream.outputs.branch }}

      - name: Set up Python 3.14
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"
          allow-prereleases: true

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "0.8.5"
          enable-cache: true
          cache-dependency-glob: uv.lock

      - name: Prepare environment
        env:
          UV_PYTHON: ${{ steps.setup-python.outputs.python-path }}
        run: |
          uv sync --frozen --all-extras --all-packages

      - name: Run ruff linting
        env:
          UV_PYTHON: ${{ steps.setup-python.outputs.python-path }}
        run: |
          uv run ruff check src/kimi_cli/ tests_gastown/

      - name: Run ruff formatting check
        env:
          UV_PYTHON: ${{ steps.setup-python.outputs.python-path }}
        run: |
          uv run ruff format --check src/kimi_cli/ tests_gastown/

  # â”€â”€â”€ Step 5: Create PR and auto-merge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr:
    needs: [check-upstream, sync-upstream, test-gastown-patch, lint-check]
    if: |
      always() &&
      needs.sync-upstream.result == 'success' &&
      needs.sync-upstream.outputs.merge_conflict == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sync branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.sync-upstream.outputs.branch }}

      - name: Create or update Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ needs.sync-upstream.outputs.branch }}
          base: main
          title: "chore: sync upstream kimi-cli ${{ needs.check-upstream.outputs.upstream_version }}"
          body: |
            ## Automated upstream sync

            **Upstream**: `${{ env.UPSTREAM_REPO }}` @ `${{ needs.check-upstream.outputs.upstream_sha }}`
            **Version**: `${{ needs.check-upstream.outputs.fork_version }}` â†’ `${{ needs.check-upstream.outputs.upstream_version }}`

            ### Checks
            - ${{ needs.test-gastown-patch.result == 'success' && 'âœ…' || 'âŒ' }} Gastown wire protocol smoke test
            - ${{ needs.test-gastown-patch.result == 'success' && 'âœ…' || 'âŒ' }} Gastown print mode smoke test
            - ${{ needs.test-gastown-patch.result == 'success' && 'âœ…' || 'âŒ' }} Gastown patch present in prompt.py
            - ${{ needs.lint-check.result == 'success' && 'âœ…' || 'âŒ' }} Lint checks

            ### Auto-merge
            This PR will be auto-merged if all checks pass.
            If the gastown patch was lost during merge, manual re-application is needed.

            ---
            *Created by [sync-upstream](.github/workflows/sync-upstream.yml) workflow*
          labels: |
            automated
            upstream-sync

      - name: Auto-merge PR
        if: |
          needs.test-gastown-patch.result == 'success' &&
          needs.lint-check.result == 'success' &&
          steps.create-pr.outputs.pull-request-number
        run: |
          gh pr merge "${{ steps.create-pr.outputs.pull-request-number }}" \
            --auto --squash \
            --subject "chore: sync upstream kimi-cli ${{ needs.check-upstream.outputs.upstream_version }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€ Handle merge conflicts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  conflict-alert:
    needs: [check-upstream, sync-upstream]
    if: needs.sync-upstream.outputs.merge_conflict == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4

      - name: Create conflict issue
        run: |
          gh issue create \
            --title "ğŸš¨ Upstream sync conflict: kimi-cli ${{ needs.check-upstream.outputs.upstream_version }}" \
            --body "$(cat <<'BODY'
          ## Upstream sync conflict

          The automated sync from `${{ env.UPSTREAM_REPO }}` encountered a merge conflict
          when trying to merge upstream version **${{ needs.check-upstream.outputs.upstream_version }}**.

          ### What to do

          1. Fetch upstream:
             ```sh
             cd kimi-cli
             git fetch upstream main
             ```

          2. Create a branch and resolve the conflict:
             ```sh
             git checkout -b fix/upstream-sync-${{ needs.check-upstream.outputs.upstream_version }}
             git merge upstream/main
             # Resolve conflicts, especially in src/kimi_cli/ui/shell/prompt.py
             ```

          3. Verify the gastown patch is still present:
             ```sh
             grep -n 'Gas Town compatibility' src/kimi_cli/ui/shell/prompt.py
             ```

          4. Run tests:
             ```sh
             python tests_gastown/test_wire_smoke.py
             python tests_gastown/test_print_smoke.py
             ```

          5. Push and merge:
             ```sh
             git push origin fix/upstream-sync-${{ needs.check-upstream.outputs.upstream_version }}
             gh pr create --title "fix: resolve upstream sync conflict for ${{ needs.check-upstream.outputs.upstream_version }}"
             ```

          ### Details
          - **Upstream version**: ${{ needs.check-upstream.outputs.upstream_version }}
          - **Fork version**: ${{ needs.check-upstream.outputs.fork_version }}
          - **Upstream SHA**: ${{ needs.check-upstream.outputs.upstream_sha }}
          BODY
          )" \
            --label "upstream-sync,conflict"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
