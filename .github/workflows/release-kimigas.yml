name: Release (kimigas)

on:
  push:
    tags:
      - "v[0-9]*"

permissions:
  contents: write

env:
  KIMIGAS_VERSION: ${{ github.ref_name }}

jobs:
  build:
    name: Build binaries (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            os: linux
            arch: amd64
          - runner: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            os: linux
            arch: arm64
          - runner: macos-14
            target: aarch64-apple-darwin
            os: darwin
            arch: arm64
          - runner: windows-2022
            target: x86_64-pc-windows-msvc
            os: windows
            arch: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GNU Make (Windows)
        if: runner.os == 'Windows'
        run: choco install make -y

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python 3.14
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"
          allow-prereleases: true

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "0.8.5"

      - name: Set up Node.js (web build)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Prepare build environment
        run: make prepare-build

      - name: Build standalone binary
        run: make build-bin

      - name: Package binary
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME#v}"
          TARGET="${{ matrix.target }}"
          mkdir -p artifacts

          if [[ "${{ matrix.os }}" == "windows" ]]; then
            BINARY="dist/onefile/kimi.exe"
            ARCHIVE="artifacts/kimigas-${TAG}-${TARGET}.zip"
            cd dist/onefile && zip -9 "../../${ARCHIVE}" kimi.exe && cd ../..
          else
            BINARY="dist/onefile/kimi"
            ARCHIVE="artifacts/kimigas-${TAG}-${TARGET}.tar.gz"
            tar -czf "${ARCHIVE}" -C dist/onefile kimi
          fi

          echo "Built: ${ARCHIVE}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kimigas-${{ matrix.target }}
          path: artifacts/*
          if-no-files-found: error
          retention-days: 7

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./downloads
          merge-multiple: true

      - name: Generate SHA256 checksums
        run: |
          cd downloads
          for f in *.tar.gz *.zip; do
            [ -f "$f" ] && sha256sum "$f" > "$f.sha256"
          done
          ls -la

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: kimigas ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            downloads/*.tar.gz
            downloads/*.zip
            downloads/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-pypi:
    name: Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.14
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"
          allow-prereleases: true

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          version: "0.8.5"

      - name: Set up Node.js (web build)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Build Python package
        run: |
          uv build --package kimi-cli
          ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: dist

  publish-npm:
    name: Publish to npm
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish npm package
        working-directory: npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          npm version "$VERSION" --no-git-tag-version
          npm publish --access public

  publish-deb:
    name: Build and attach .deb packages
    needs: build
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: amd64
          - target: aarch64-unknown-linux-gnu
            arch: arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: kimigas-${{ matrix.target }}
          path: ./downloads

      - name: Build .deb package
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          ARCH="${{ matrix.arch }}"

          # Extract binary
          mkdir -p extract
          tar -xzf downloads/kimigas-${VERSION}-${{ matrix.target }}.tar.gz -C extract/

          # Build deb structure
          PKG="kimigas_${VERSION}_${ARCH}"
          mkdir -p "${PKG}/DEBIAN"
          mkdir -p "${PKG}/usr/bin"
          mkdir -p "${PKG}/usr/share/doc/kimigas"

          cp extract/kimi "${PKG}/usr/bin/kimigas"
          chmod 755 "${PKG}/usr/bin/kimigas"

          # Also symlink as 'kimi' for upstream compatibility
          ln -s kimigas "${PKG}/usr/bin/kimi"

          cat > "${PKG}/DEBIAN/control" << CTRL
          Package: kimigas
          Version: ${VERSION}
          Architecture: ${ARCH}
          Maintainer: Gas Town <gastown@villamarket.ai>
          Description: Kimi Code CLI for Gas Town
           kimigas is a Gas Town fork of kimi-cli by MoonshotAI. An AI agent
           that runs in the terminal for software development tasks and
           multi-agent orchestration.
          Homepage: https://github.com/gastown-publish/kimigas
          Section: devel
          Priority: optional
          CTRL
          # Remove leading spaces from heredoc
          sed -i 's/^          //' "${PKG}/DEBIAN/control"

          cp README.md "${PKG}/usr/share/doc/kimigas/"

          dpkg-deb --build --root-owner-group "${PKG}"
          mv "${PKG}.deb" "kimigas_${VERSION}_${ARCH}.deb"

          echo "Built: kimigas_${VERSION}_${ARCH}.deb"

      - name: Upload .deb to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: "*.deb"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
